name: Deploy to Cloudflare Workers

on:
  push:
    branches: [main]
    paths:
      - "back/**"
      - ".github/workflows/deploy-back.yml"

  workflow_dispatch:

env:
  DENO_VERSION: "v2.x"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: ${{ env.DENO_VERSION }}

      - name: Setup Denoflare
        run: |
          deno install --global --unstable-worker-options --allow-read --allow-net --allow-env --allow-run --allow-write --allow-import --name denoflare --reload --force https://raw.githubusercontent.com/skymethod/denoflare/master/cli/cli.ts
          echo "$HOME/.deno/bin" >> $GITHUB_PATH

      - name: Generate .denoflare config
        run: |
          envsubst < ./back/.denoflare.template > ./back/.denoflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SPOTIFY_REFRESH_TOKEN: ${{ secrets.SPOTIFY_REFRESH_TOKEN }}
          YANOPORTFOLIO_BACK_CACHE: ${{ secrets.YANOPORTFOLIO_BACK_CACHE }}

      - name: Deploy Workers
        run: make back.deploy
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Enable Smart Placement
        if: success()
        run: |
          curl -X PATCH \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/workers/scripts/yanoportfolio-back/settings" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -F 'settings={"placement": {"mode": "smart"}}' \
            --fail-with-body --silent --show-error
